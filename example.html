<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Raster JS Demo</title>

 		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" />
		<script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"></script>

		<!-- Load proj4js then the dataset -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.5.0/proj4.js"></script>
		<script src="./kampala.js"></script>

		<style>
			#map {
				width: 800px;
				height: 500px;
			}
		</style>
	</head>
	<body onload="initMap();">
		<div id='map'></div>

		<script>

      // global variable for map
      let map;

      /**
       * Initialise the map
       */
      function initMap() {

        // init the map
        map = L.map('map').fitBounds(kampala.getGeoBounds2());

        // add some tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(map);

				// log tests to console
				// TEST_properties(kampala);
				// TEST_transforms(kampala, [parseInt(kampala.width/2), parseInt(kampala.height/2)]);

				// initialise array for ndvi results
				ndvilayer = [];

				// loop through every single column
				for(let x = 0; x < kampala.width; x++){

					// add a new column
					ndvilayer.push([]);

					// loop through every single pixel in the column
					for(let y = 0; y < kampala.height; y++){

						//calculate ndvi for each pixel
						ndvilayer[x][y] = ndvi(kampala.band3[x][y], kampala.band4[x][y]);
					}
				}

				// print a random value to show it worked
				console.log(kampala.width, ndvilayer.length);
				console.log(kampala.height, ndvilayer[0].length);
				console.log(ndvilayer[100][100]);
			}


			/**
			 * Normalised Difference Vegetation Index calculation
			 */
			function ndvi(red, nir){
				return (nir - red) / (nir + red);
			}


			/**
			 * Set of simple tests to demonstrate that data has loaded
			 */
			function TEST_properties(layer){
				// test properties
				console.log(layer.bands);
				console.log(layer.bl);
				console.log(layer.tl);
				console.log(layer.br);
				console.log(layer.tr);
				console.log(layer.bounds);
				console.log(layer.resolution);
				console.log(layer.width);
				console.log(layer.height);
				console.log(layer.proj);
				console.log(layer.transformer);
				console.log("---");

				//test bands
				console.log(layer.band3.length, kampala.band3[0].length);
				console.log(layer.band4.length, kampala.band4[0].length);
				console.log("---");
			}

			/**
			 * Quick test to demonstrate that the coord conversions & transformations work
			 */
			function TEST_transforms(layer, tmp0) {
				console.log(tmp0);
				var tmp = layer.image2proj(tmp0)
				console.log(tmp);
				var tmp2 = layer.proj2geo(tmp);
				console.log(tmp2);
				var tmp3 = layer.geo2proj(tmp2);
				console.log(tmp3);
				console.log(layer.proj2image(tmp3));
			}
		</script>
	</body>
</html>
